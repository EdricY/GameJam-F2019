<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="index.css">
  <script>
    var loadedResrcs = 0;
    const RESRCS_TO_LOAD = 10;
    function resrcLoaded() { loadedResrcs++; loadmsg.innerHTML += "."; }
  </script>
</head>

<body id="body">
  <div id="connectDiv">
    <div>
      <label for="hostID">Host ID:</label>
      <input id="hostID" type="text" value="maybehector">
    </div>
    <div>
      <button onclick="connect()">Connect</button>
      <button onclick="host()">Host</button>
    </div>
  </div>
  <div id="myPeerID"></div>

  <div class="nodisplay" id="loadmsg">Loading</div>
  <div class="nodisplay" id="canvasDiv">
    <canvas id="canvas" width="720" height="480"></canvas>
  </div>
  <canvas hidden id="renderer" width="720" height="480"></canvas>
</body>
<img hidden id='p1sprites' onload="resrcLoaded()" src='resrc/girl1Sheet.png'>
<img hidden id='p2sprites' onload="resrcLoaded()" src='resrc/girl2Sheet.png'>
<img hidden id='portalSprites' onload="resrcLoaded()" src='resrc/portalSheet.png'>
<img hidden id='cmapImg0' onload="resrcLoaded()" src='resrc/L0.png'>
<img hidden id='cmapImg1' onload="resrcLoaded()" src='resrc/L1.png'>
<img hidden id='cmapImg2' onload="resrcLoaded()" src='resrc/L2.png'>
<img hidden id='cmapImg3' onload="resrcLoaded()" src='resrc/L3.png'>
<img hidden id='cmapImg4' onload="resrcLoaded()" src='resrc/L4.png'>
<img hidden id='cmapImg5' onload="resrcLoaded()" src='resrc/L5.png'>
<img hidden id='backImg2' onload="resrcLoaded()" src='resrc/backimg2.png'>

<script src="src/peer.js"></script> <!-- https://peerjs.com/ -->
<script src="src/constants.js"></script>
<script src="src/keys.js"></script>
<script src="src/imgutil.js"></script>
<script src="src/collisionMap.js"></script>
<script src="src/camera.js"></script>
<script src="src/player.js"></script>
<script src="src/animator.js"></script>
<script src="src/portal.js"></script>
<script src="src/world.js"></script>
<script defer src="src/game.js"></script>

<script>
  var peer;
  var untouched = true;
  var hosting = false;
  var connected = false;
  var connection;
  
  var loadInterval;

  var peeking = false;
  var peekImg = document.createElement("img");
  var peekImgReady = false;
  var outstandingPeekReq = false;

  var swapInProgress = false;
  var swapTimer = 60;
  var swapMsgSent = false;
  var swapFollowUpTimer = 60;
  var swapData = {};

  function host() {
    let peerid = hostID.value
    peer = new Peer(peerid);
    myPeerID.innerHTML = "Initializing...";
    peer.on('open', () => {
      myPeerID.innerHTML = "Host ID: " + peer.id + "<br>Waiting for your partner...";
      connectDiv.classList.add("nodisplay")
    });

    peer.on('error', () => {
      myPeerID.innerHTML = "There was an error setting up the connection. Please reload and try again later";
    });

    peer.on('close', () => {
      myPeerID.innerHTML = "The connection was closed.";
      location.reload();
    });

    hosting = true;
    peer.on('connection', function (conn) {
      console.log('host onconnection')
      connection = conn;
      conn.on('data', function (data) {
        console.log(data)
        if (untouched) {
          if (data === "readyforgamejam") {
            untouched = false;
            console.log("connected to client!")
            connected = true;
            conn.send("yeahletsgo");
            loadInterval = setInterval(attemptInit, 1000);
            connectDiv.classList.add("nodisplay");
            loadmsg.classList.remove("nodisplay");
          }
          // ignore anything else
          return;
        }
        handleMessage(data);
      });
    });
  }

  function connect() {
    peer = new Peer();
    peer.on('error', () => {
      myPeerID.innerHTML = "There was an error finding the host. Please try again.";
      location.reload();
    });
    peer.on('close', () => {
      myPeerID.innerHTML = "The connection was closed.";
      location.reload();
    });
    peer.on('disconnected', () => {
      myPeerID.innerHTML = "The connection was disconnected.";
      location.reload();
    });
    peer.on('open', () => {
      myPeerID.innerHTML = "Client ID: " + peer.id;
      connectDiv.classList.add("nodisplay")
      connection = peer.connect(hostID.value);
      connection.on('data', function (data) {
        console.log(data)
        if (untouched) {
          if (data === "yeahletsgo") {
            untouched = false;
            console.log('connected to host!')
            connected = true;
            loadInterval = setInterval(attemptInit, 1000);
            connectDiv.classList.add("nodisplay");
            loadmsg.classList.remove("nodisplay");
          }
          // ignore anything else
          return;
        }
        handleMessage(data);
      });
      connection.on('open', function () {
        console.log('client connection onopen')
        connection.send('readyforgamejam');
        connected = true;
      });
      connection.on('error', function () {
        console.log('client connection error')
      });
      connection.on('close', function () {
        console.log('client connection close')
      });
    });

    peer.on('connection', () => {
      console.log('client onconnection')
    });

  }

  //receiving messages
  function handleMessage(data) {
    let parsed = JSON.parse(data);
    let type = parsed.type;
    let obj = parsed.obj;
    switch (type) {
      case PEEKREQ: {
        if (swapInProgress) break;
        if (peeking)  {//swap
          swapInProgress = true;
          // both enter here once per swap.
        } else { // send them my canvas
          outstandingPeekReq = true;
        }
        break;
      }
      case PEEKMSG: {
        peekImg.src = obj;
        peekImg.onload = () => peekImgReady = true;
        break;
      }
      case SWAPMSG: {
        swapData = obj;
        break;
      }
    }
  }

  function getSwapData() {
    return {
      x: activePortal.x,
      y: activePortal.y,
    }
  }

  function newPacket(type, obj){
    return JSON.stringify({'type': type, 'obj': obj});
  }

  function attemptInit() {
    if (loadedResrcs == RESRCS_TO_LOAD) {
      clearInterval(loadInterval)
      gameInit(hosting);
      loadmsg.classList.add("nodisplay");
      myPeerID.classList.add("nodisplay");
      canvasDiv.classList.remove("nodisplay");
    }
  }

</script>

</html>