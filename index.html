<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="index.css">
  <script>
    var loadedResrcs = 0;
    const RESRCS_TO_LOAD = 36;
    function resrcLoaded() { loadedResrcs++; loadmsg.innerHTML += "."; }

    function drawTitle() {
      document.getElementById('canvas').getContext("2d").drawImage(titleImg, 0, 0, renderer.width, renderer.height)
    }
  </script>
</head>

<body id="body">
  <div id="connectDiv">
    <div>
      <label for="hostID">Host ID:</label>
      <input id="hostID" type="text" value="penelope" maxlength="25">
    </div>
    <div>
      <button onclick="connect()">Connect</button>
      <button onclick="host()">Host</button>
      <button onclick="playSolo()">Play Solo</button>
    </div>
  </div>
  <div id="myPeerID"></div>

  <div class="nodisplay" id="loadmsg">Loading</div>
  <div class="nodisplay" id="canvasDiv">
    <canvas id="canvas" width="720" height="480"></canvas>
  </div>
  <canvas hidden id="renderer" width="720" height="480"></canvas>
</body>
<audio id="p1audio" src="resrc/wallace_badworld.mp3" oncanplay="resrcLoaded()" loop></audio>
<audio id="p2audio" src="resrc/wallace_goodworld.mp3" oncanplay="resrcLoaded()" loop></audio>
<audio id="pumpkinSound" src="resrc/pumpkinsound.wav" oncanplay="resrcLoaded()"></audio>
<audio id="attackSound" src="resrc/attack.wav" oncanplay="resrcLoaded()"></audio>
<audio id="axeSound" src="resrc/axesound.wav" oncanplay="resrcLoaded()"></audio>
<audio id="zombieDieSound" src="resrc/zombiedead.wav" oncanplay="resrcLoaded()"></audio>
<audio id="endgameAudio" src="resrc/wallace_neutral.mp3"></audio>

<img hidden id='p1sprites' onload="resrcLoaded()" src='resrc/girl1Sheet.png'>
<img hidden id='p2sprites' onload="resrcLoaded()" src='resrc/girl2Sheet.png'>
<img hidden id='portalSprites' onload="resrcLoaded()" src='resrc/portalSheet.png'>
<img hidden id='pumpkinSprites' onload="resrcLoaded()" src='resrc/pumpkinsheet.png'>
<img hidden id='zombieImg' onload="resrcLoaded()" src='resrc/zombie.png'>
<img hidden id='heartImg' onload="resrcLoaded()" src='resrc/heart.png'>
<img hidden id='graveImg' onload="resrcLoaded()" src='resrc/gravestone.png'>
<img hidden id='cmapImg0' onload="resrcLoaded()" src='resrc/L0.png'>
<img hidden id='cmapImg1' onload="resrcLoaded()" src='resrc/L1.png'>
<img hidden id='cmapImg2' onload="resrcLoaded()" src='resrc/L2.png'>
<img hidden id='cmapImg3' onload="resrcLoaded()" src='resrc/L3.png'>
<img hidden id='cmapImg4' onload="resrcLoaded()" src='resrc/L4.png'>
<img hidden id='cmapImg5' onload="resrcLoaded()" src='resrc/L5.png'>
<img hidden id='cmapImg6' onload="resrcLoaded()" src='resrc/L6.png'>
<img hidden id='cmapImg7' onload="resrcLoaded()" src='resrc/L7.png'>
<img hidden id='cmapImg8' onload="resrcLoaded()" src='resrc/L8.png'>
<img hidden id='backImg0' onload="resrcLoaded()" src='resrc/G0.png'>
<img hidden id='backImg1' onload="resrcLoaded()" src='resrc/G1.png'>
<img hidden id='backImg2' onload="resrcLoaded()" src='resrc/G2.png'>
<img hidden id='backImg3' onload="resrcLoaded()" src='resrc/G3.png'>
<img hidden id='backImg4' onload="resrcLoaded()" src='resrc/G4.png'>
<img hidden id='backImg5' onload="resrcLoaded()" src='resrc/G5.png'>
<img hidden id='backImg6' onload="resrcLoaded()" src='resrc/G6.png'>
<img hidden id='backImg7' onload="resrcLoaded()" src='resrc/G7.png'>
<img hidden id='backImg8' onload="resrcLoaded()" src='resrc/G8.png'>
<img hidden id='backgroundImg1' onload="resrcLoaded()" src='resrc/backdrop night.png'>
<img hidden id='backgroundImg2' onload="resrcLoaded()" src='resrc/backdrop day.png'>
<img hidden id='titleImg' onload="resrcLoaded(); drawTitle()" src='resrc/title screen.png'>
<img hidden id='creditsImg' onload="resrcLoaded()" src='resrc/credits.png'>


<script src="src/peer.js"></script> <!-- https://peerjs.com/ -->
<script src="src/constants.js"></script>
<script src="src/keys.js"></script>
<script src="src/hearts.js"></script>
<script src="src/imgutil.js"></script>
<script src="src/collisionMap.js"></script>
<script src="src/camera.js"></script>
<script src="src/attackhitbox.js"></script>
<script src="src/player.js"></script>
<script src="src/animator.js"></script>
<script src="src/portal.js"></script>
<script src="src/pumpkin.js"></script>
<script src="src/baddies.js"></script>
<script src="src/world.js"></script>
<script src="src/particles.js"></script>
<script defer src="src/game.js"></script>

<script>
  var peer;
  var untouched = true;
  var hosting = false;
  var connection;
  
  var loadInterval;

  var peeking = false;
  var peekImg = document.createElement("img");
  var peekImgReady = false;
  var outstandingPeekReq = false;

  var swapInProgress = false;
  var swapTimer = 60;
  var swapMsgSent = false;
  var swapFollowUpTimer = 60;
  var swapData = {};
  var isP1 = false;
  var solo = false;


  var gameWon = false;

  function host() {
    let peerid = hostID.value
    peer = new Peer(peerid);
    myPeerID.innerHTML = "Initializing...";
    peer.on('open', () => {
      myPeerID.innerHTML = "Host ID: " + peer.id + "<br>Waiting for your partner...";
      connectDiv.classList.add("nodisplay")
    });

    peer.on('error', () => {
      myPeerID.innerHTML = "There was an error setting up the connection. Please reload and try again later";
      setTimeout(() => location.reload(), 2000);
    });

    peer.on('close', () => {
      myPeerID.innerHTML = "The connection was closed.";
      setTimeout(() => location.reload(), 2000);
    });

    hosting = true;
    peer.on('connection', function (conn) { //setup
      console.log('host onconnection')
      connection = conn;
      loadInterval = setInterval(attemptInit, 1000);
      connectDiv.classList.add("nodisplay");
      loadmsg.classList.remove("nodisplay");

      conn.on('data', function (data) { //msg handler
        handleMessage(data);
      });
    });
  }

  function connect() {
    peer = new Peer();
    peer.on('error', () => {
      console.log('client error')
      myPeerID.innerHTML = "There was an error finding the host. Please try again.";
      setTimeout(() => location.reload(), 2000);
    });
    peer.on('close', () => {
      console.log('client close')
      myPeerID.innerHTML = "The connection was closed.";
      setTimeout(() => location.reload(), 2000);
    });
    peer.on('disconnected', () => {
      console.log('client disconnect')
      myPeerID.innerHTML = "The connection was disconnected.";
      setTimeout(() => location.reload(), 2000);
    });

    peer.on('open', () => {
      myPeerID.innerHTML = "Client ID: " + peer.id;
      connectDiv.classList.add("nodisplay");
      connection = peer.connect(hostID.value);

      connection.on('open', function () { //setup
        loadInterval = setInterval(attemptInit, 1000);
        connectDiv.classList.add("nodisplay");
        loadmsg.classList.remove("nodisplay");
      });
      connection.on('error', function () {
        console.log('client connection error')
      });
      connection.on('close', function () {
        console.log('client connection close')
      });

      connection.on('data', function (data) { //msg handler
        handleMessage(data);
      });
    });

    peer.on('connection', () => {
      console.log('client onconnection')
    });

  }

  function playSolo() {
    solo = true;
    isP1 = true;
    loadInterval = setInterval(attemptInit, 1000);
    connectDiv.classList.add("nodisplay");
    loadmsg.classList.remove("nodisplay");
  }

  //receiving messages
  function handleMessage(data) {
    let parsed = JSON.parse(data);
    let type = parsed.type;
    let obj = parsed.obj;
    switch (type) {
      case PEEKREQ: {
        if (swapInProgress) break;
        if (peeking)  {//swap
          swapInProgress = true;
          // both enter here once per swap.
        } else { // send them my canvas
          outstandingPeekReq = true;
        }
        break;
      }
      case PEEKMSG: {
        peekImg.src = obj;
        peekImg.onload = () => peekImgReady = true;
        break;
      }
      case SWAPMSG: {
        swapData = obj;
        break;
      }
    }
  }

  function getSwapData() {
    let data = {}
    data.px = activePortal.x;
    data.py = activePortal.y;
    if (isP1) {
    
    } else {
      
    }

    return data;
  }

  function newPacket(type, obj){
    return JSON.stringify({'type': type, 'obj': obj});
  }

  function attemptInit() {
    if (loadedResrcs == RESRCS_TO_LOAD) {
      if (!solo) isP1 = hosting;
      clearInterval(loadInterval)
      gameInit();
      loadmsg.classList.add("nodisplay");
      myPeerID.classList.add("nodisplay");
      canvasDiv.classList.remove("nodisplay");
    }
  }

  function winGame() {
    gameWon = true;
    requestAnimationFrame(showWinScreen)

    if (isP1) {
        let audiotime = p1audio.currentTime;
        p1audio.pause();
        endgameAudio.currentTime = audiotime;
        endgameAudio.play();
    } else {
        let audiotime = p2audio.currentTime;
        p2audio.pause();
        endgameAudio.currentTime = audiotime;
        endgameAudio.play();
    }
  }

  var winTimer = 50;
  var winPhase1 = true;
  var specialPumpkinSmashed = false;
  function showWinScreen() {
    ctx.globalAlpha = 1 - winTimer/50; //not how to do a real fade - should draw other img in between
    ctx.drawImage(creditsImg, 0, 0, VW, VH);
    if (specialPumpkinSmashed) {
      let frame = { x:10, y:70, w:89, h:51, px:54, py:119 }
      let top = 354 - (frame.py - frame.y);
      let left = 200 - (frame.px - frame.x);
      ctx.drawImage(pumpkinSprites, frame.x, frame.y, frame.w, frame.h, left, top, frame.w, frame.h);
    }
    // ctx.fillStyle = "white"
    // ctx.fillRect(0, 0, VW, VH);
    
    // ctx.globalAlpha = 1;
    // ctx.fillStyle = "black";
    // ctx.font = "20px serif";
    // ctx.textAlign = "center";
    // ctx.textBaseline = "alphabetic";
    // ctx.fillText("You Win!", VW/2, VH/2);
    if (--winTimer > 0) requestAnimationFrame(showWinScreen)
  }

  

// old audio data
// p1audio.duration == 34.847313
// p2audio.duration == 34.899563
// endgameAudio.duration == 34.909093

function loopMusic() {
  if (p1audio.currentTime > 34.85) p1audio.currentTime -= 34.85;
  if (p2audio.currentTime > 34.9) p2audio.currentTime -= 34.9;
  if (endgameAudio.currentTime > 34.9) endgameAudio.currentTime -= 34.9;
}

setInterval(loopMusic, 1000);

</script>

</html>